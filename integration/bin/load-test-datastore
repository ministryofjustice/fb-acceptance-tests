#!/usr/bin/env bash

user_identifier=$1
number_of_requests=100
concurrency=100

BASEDIR=$(dirname $0)
access_token=$($BASEDIR/find_access_token $user_identifier)

if [[ $access_token =~ "You need to create" ]]; then
  echo "access token must be set"
  exit 1
fi

url="http://localhost:10001/service/slug/user/$user_identifier"

echo "======== Apache Benchmark for 'POST ${url}' ========="
ab -n $number_of_requests -c $concurrency -H "x-access-token-v2: ${access_token}" -p "${BASEDIR}/datastore_request_body" -T application/json  $url

echo "======== Apache Benchmark for 'GET ${url}' ========="
ab -n $number_of_requests -c $concurrency -H "x-access-token-v2: ${access_token}" $url

echo "======= Vegeta Attack for 'GET ${url}' =========="
echo "GET $url" | \
  vegeta attack -header "x-access-token-v2: ${access_token}" \
  -duration=30s | \
  tee results.bin | \
  vegeta report

echo "======= Vegeta Attack for 'POST ${url}' =========="
  echo "POST $url" | \
  vegeta attack -header "x-access-token-v2: ${access_token}" \
  -body "${BASEDIR}/datastore_request_body" \
  -duration=30s | \
  tee results.bin | \
  vegeta report
